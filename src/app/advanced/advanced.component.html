<h1> Paramètres avancés </h1>

<div class="col">
    <div class="row">
        <button type="button" class="btn btn-info" (click)="displayEventForm()"> Ajouter un évènement</button>
        <button type="button" class="btn btn-info" (click)="displayPlanForm()"> Planifier un conducteur</button>
    </div>
</div>

<div *ngIf="displayPlanDriver">
    <div class="row">
        <div class="col-3">
            <label for="date">Date : </label>
            <input class="form-control" type="date" id="date" placeholder="jj/mm/aaaa" [(ngModel)]="selectedDatePlan">
        </div>
        <div class="col-3">
            <label for="driver">Conducteur à planifier: </label>
            <select id="driver" [(ngModel)]="selectedPlanDriverId">
                <option *ngFor="let driver of driverList" [value]="driver.id">
                    {{driver.firstname | lowercase }} {{driver.lastname | uppercase }}
                </option>
            </select>
        </div>

        <div class="col-5">
            <div class="row">
                <div class="col">
                    <label for="startHourPlanSelected"> De : </label>
                    <select id="startHourPlanSelected" [(ngModel)]="startHourPlanSelected"
                        (change)="updateHoursJobFrom()">
                        <option *ngFor="let hour of hours_job" [value]="hour">
                            {{hour}} h 00
                        </option>
                    </select>
                </div>
                <div class="col">
                    <label for="endHourPlanSelected"> A : </label>
                    <select id="endHourPlanSelected" [(ngModel)]="endHourPlanSelected">
                        <option *ngFor="let hour of hours_job_from" [value]="hour">
                            {{hour}} h 00
                        </option>
                    </select>
                </div>
            </div>
        </div>
        <button type="button" class="btn btn-info"
            *ngIf="selectedDatePlan !== null && selectedPlanDriverId !== null && startHourPlanSelected !== null && endHourPlanSelected !== null"
            (click)="planDriver()">
            Planifier
        </button>
    </div>
    <small class="col" style="text-align: center;">Seuls les évènements complets (patient, origine et destination) seront enregistrés.</small>
    <div class="row" *ngFor="let hour of intervalsHour; let index = index" style="margin: 1%;">
        <div class="col-2">{{hour[0]}} - {{hour[1]}} | </div>
        <div class="col-2">
            <label for="patient"> Patient : </label>
            <select id="patient" (change)="savePatientPlanSelection(hour, index, $event.target.value)">
                <option [value]="0"></option>
                <option *ngFor="let patient of patientList" [value]="patient.id">
                    {{patient.firstname | lowercase }} {{patient.lastname | uppercase }}
                </option>
            </select>
        </div>
        <div class="col">
            <label for="journey"> Trajet : </label>
            <div class="row">
                De :
                <div class="col">
                    <select id="startPoint" (change)="saveStartPointSelection(hour, index, $event.target.value)">
                        <option [value]="0"></option>
                        <option *ngFor="let place of placeList" [value]="place.id">
                            {{place.label | uppercase }}
                        </option>
                    </select>
                </div>
                Vers :
                <div class="col">
                    <select id="endPoint" (change)="saveEndHourSelection(hour, index, $event.target.value)">
                        <option [value]="0"></option>
                        <option *ngFor="let place of placeList" [value]="place.id">
                            {{place.label | uppercase }}
                        </option>
                    </select>
                </div>
            </div>
        </div>
        <i class="fas fa-times" (click)="removeInterval(hour)"></i>
        <div class="col-12" style="background-color: orange; height: 3px; margin-top: 1%;"></div>
    </div>
</div>

<form [formGroup]="eventForm" (ngSubmit)="onSubmit()" *ngIf="displayForm">
    <div class="row">
        <div class="col-10">
            <h3 *ngIf="!updatingEvent">Ajouter un évènement récurrent</h3>
        </div>
        <div class="col-2">
            <button type="button" class="btn btn-link" (click)="clearEventForm()">Fermer</button>
        </div>
    </div>

    <div class="row">
        <div class="col-2">
            <label for="driver">Conducteur : </label>
            <select formControlName="driver" id="driver" [(ngModel)]="selectedDriverId">
                <option *ngFor="let driver of driverList" [value]="driver.id">
                    {{driver.firstname | lowercase }} {{driver.lastname | uppercase }}
                </option>
            </select>
        </div>
        <div class="col-2">
            <label for="patient">Patient : </label>
            <select formControlName="patient" id="patient" [(ngModel)]="selectedPatientId">
                <option *ngFor="let patient of patientList" [value]="patient.id">
                    {{patient.firstname | lowercase }} {{patient.lastname | uppercase }}
                </option>
            </select>
        </div>
        <div class="col">
            <label for="journey"> Trajet : </label>
            <div class="row">
                De :
                <div class="col">
                    <select formControlName="startPoint" id="startPoint" [(ngModel)]="selectedStartPointId">
                        <option *ngFor="let place of placeList" [value]="place.id">
                            {{place.label | uppercase }}
                        </option>
                    </select>
                </div>
                Vers :
                <div class="col">
                    <select formControlName="endPoint" id="endPoint" [(ngModel)]="selectedEndPointId">
                        <option *ngFor="let place of placeList" [value]="place.id">
                            {{place.label | uppercase }}
                        </option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-3">
            <label for="date">Date : </label>
            <input class="form-control" type="date" id="date" placeholder="jj/mm/aaaa" formControlName="date" (change)="uncheckAllCheckbox()">
        </div>
        <div class="col-2">
            <label for="startHour">Départ : </label>
            <div class="input-group">
                <input class="form-control" type="time" id="startHour" formControlName="startHour" (change)="uncheckAllCheckbox()"
                    [(ngModel)]="startHourSelected">
            </div>
        </div>
        <div class="col-2">
            <label for="endHour">Retour : </label>
            <input type="time" id="endHour" class="form-control" formControlName="endHour" [value]="startHourSelected" (change)="uncheckAllCheckbox()">
        </div>
    </div>

    <div class="row">
        <div class="col">
            <label> Récurrence : </label>
            <div class="form-check form-check-inline" *ngFor="let day of checklist">
                <input class="form-check-input" type="checkbox" [value]="day.id"
                    (change)="updateCheckedList($event)" [checked]="day.isSelected">
                <label class="form-check-label">{{day.label}}</label>
            </div>

        </div>
    </div>

    <p *ngIf="checkedlist.length > 0"> Cet évènement sera ajouté tous les <i *ngFor="let day of checkedlist">{{day.label}}, </i> à compter du
        {{eventForm.get('date').value | date: 'dd/MM/yyyy'}} pendant 2 semaines.</p>

    <p *ngIf="checkedlist.length > 0">Evènements à ajouter</p>
    <p *ngFor="let event of eventListToDisplay">
        {{event.date | date:"dd/MM/yyyy" }} | De {{event.startHour}} à {{event.endHour}}
    </p>


    <div style="color:red" *ngIf="!eventForm.valid && eventForm.touched">
        Veuillez rentrer des valeurs valides.
    </div>
    <div class="col">
        <button type="submit" class="btn btn-info" [disabled]="!eventForm.valid">Valider</button>
    </div>

</form>

<button *ngIf="displaySaveButton" type="button" class="btn btn-info" (click)="savePlan()"> Sauvegarder le planning</button>